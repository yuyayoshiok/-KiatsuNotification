# AWS設定ガイド

このガイドでは、気圧通知システムをAWS上にセットアップする手順を説明します。

## 1. AWS Lambda関数のセットアップ

### 1.1 Lambda関数の作成

1. AWSマネジメントコンソールにログインし、Lambda サービスに移動します。
2. 「関数の作成」をクリックします。
3. 「一から作成」を選択し、以下の情報を入力します：
   - 関数名: `KiatsuNotification`
   - ランタイム: `Python 3.9`
   - アーキテクチャ: `x86_64`
4. 「関数の作成」をクリックします。

### 1.2 デプロイパッケージのアップロード

1. `deploy.sh` スクリプトを実行してデプロイパッケージを作成します：
   ```
   ./deploy.sh
   ```
2. Lambda関数の画面で「コード」タブを選択し、「アップロード元」→「.zipファイル」を選択します。
3. 作成した `lambda_deployment.zip` ファイルをアップロードします。
4. 「保存」をクリックします。

### 1.3 環境変数の設定

1. Lambda関数の「設定」タブを選択し、「環境変数」を選択します。
2. 以下の環境変数を追加します：
   - `OPENWEATHER_API_KEY`: OpenWeatherMap APIキー
   - `LINE_CHANNEL_ACCESS_TOKEN`: LINE Messaging APIのチャネルアクセストークン
   - `LINE_USER_ID`: 通知を送信するLINEユーザーID
   - `CITY_ID`: 天気を取得する都市ID（デフォルト: 1857550 島根県松江市）
   - `PRESSURE_THRESHOLD`: 低気圧の閾値（デフォルト: 1010）
   - `PRESSURE_CHANGE_THRESHOLD`: 気圧変化の閾値（デフォルト: 6）
   - `GROQ_API_KEY`: Groq APIキー
   - `USE_GROQ`: Groq APIを使用するかどうか（'true'または'false'）
   - `S3_BUCKET_NAME`: 天気データを保存するS3バケット名（デフォルト: 'kiatsu-data'）
   - `S3_ENABLED`: S3へのデータ保存を有効にするかどうか（'true'または'false'）
3. 「保存」をクリックします。

### 1.4 タイムアウト設定の変更

1. Lambda関数の「設定」タブから「一般設定」を選択します。
2. 「編集」をクリックし、タイムアウトを30秒に設定します。
3. 「保存」をクリックします。

## 2. S3バケットのセットアップ

### 2.1 S3バケットの作成

1. AWSマネジメントコンソールでS3サービスに移動します。
2. 「バケットを作成」をクリックします。
3. 以下の情報を入力します：
   - バケット名: `kiatsu-data`（または任意の一意な名前）
   - リージョン: Lambda関数と同じリージョンを選択
   - パブリックアクセスをブロックする設定: すべてのチェックボックスをオンにする（推奨）
4. 「バケットを作成」をクリックします。

### 2.2 Lambda関数にS3アクセス権限を付与

1. Lambda関数の「設定」タブから「アクセス権限」を選択します。
2. 実行ロールの名前をクリックして、IAMコンソールに移動します。
3. 「許可を追加」→「ポリシーをアタッチ」をクリックします。
4. 検索ボックスに「S3」と入力し、「AmazonS3ReadOnlyAccess」ポリシーを選択します。
5. さらに、カスタムポリシーを作成して書き込み権限を追加します：
   1. IAMコンソールで「ポリシー」→「ポリシーの作成」をクリックします。
   2. JSONタブを選択し、以下のポリシーを入力します（バケット名を適切に置き換えてください）。

      ```json
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "s3:PutObject",
              "s3:GetObject",
              "s3:DeleteObject",
              "s3:ListBucket"
            ],
            "Resource": [
              "arn:aws:s3:::kiatsu-data",
              "arn:aws:s3:::kiatsu-data/*"
            ]
          }
        ]
      }
      ```

   3. 「次へ」をクリックし、ポリシー名を「KiatsuS3WritePolicy」などとして作成します。
   4. 作成したポリシーをLambda実行ロールにアタッチします。

### 2.3 データ保持ポリシーの設定（オプション）

1. S3バケットの詳細ページで「管理」タブを選択します。
2. 「ライフサイクルルール」セクションで「ライフサイクルルールを作成する」をクリックします。
3. 以下の設定を行います：
   - ルール名: `HourlyDataCleanup`
   - ルールのスコープ: 「1 つ以上のフィルターを使用してこのルールのスコープを制限する」を選択
   - プレフィックス: `hourly/`
   - ライフサイクルルールのアクション: 「オブジェクトの有効期限切れ」を選択し、「オブジェクトの作成後」を「3日」に設定
4. 「ルールを作成」をクリックします。
5. 同様の手順で`daily/`プレフィックス用のルールも作成します：
   - ルール名: `DailyDataCleanup`
   - ルールのスコープ: 「1 つ以上のフィルターを使用してこのルールのスコープを制限する」を選択
   - プレフィックス: `daily/`
   - ライフサイクルルールのアクション: 「オブジェクトの有効期限切れ」を選択し、「オブジェクトの作成後」を「3日」に設定
6. 「ルールを作成」をクリックします。

## 3. EventBridge (CloudWatch Events) の設定

### 3.1 定期実行ルールの作成

1. AWSマネジメントコンソールで EventBridge サービスに移動します。
2. 「ルール」→「ルールの作成」をクリックします。
3. 以下の情報を入力します：
   - 名前: `DailyKiatsuNotification`
   - 説明: `毎日の気圧通知を実行する`
   - ルールタイプ: `スケジュール`
4. スケジュールパターンで「cron式」を選択し、以下のように設定します：
   - タイムゾーン: `Asia/Tokyo`（日本時間）を選択
   ```
   0 6 * * ? *
   ```
   （毎日日本時間の朝6:00に実行）
5. 「次へ」をクリックします。

### 3.2 ターゲットの設定

1. ターゲットタイプで「AWS サービス」を選択します。
2. ターゲットの選択で「Lambda関数」を選択します。
3. 関数で先ほど作成した `KiatsuNotification` を選択します。
4. 「次へ」をクリックします。
5. タグの設定はスキップし、「次へ」をクリックします。
6. 設定を確認し、「ルールの作成」をクリックします。

## 4. LINE Bot の設定

### 4.1 LINE Developersでチャネルを作成

1. [LINE Developers Console](https://developers.line.biz/console/) にアクセスします。
2. プロバイダーを選択または作成します。
3. 「新規チャネル作成」をクリックし、「Messaging API」を選択します。
4. 必要な情報を入力してチャネルを作成します：
   - チャネル名: `Kiatsu通知`（任意）
   - チャネルの説明: `気圧の変化を通知するBotです`（任意）
   - 大業種: `個人`
   - 小業種: `個人（その他）`
5. 作成したチャネルの「Messaging API設定」タブから、チャネルアクセストークンを発行します。
6. このトークンをLambda関数の環境変数 `LINE_CHANNEL_ACCESS_TOKEN` に設定します。

### 4.2 ユーザーIDの取得

1. LINE Botを友達に追加します。
2. LINE Developersコンソールの「チャネル基本設定」から「あなたのユーザーID」を確認します。
3. このユーザーIDをLambda関数の環境変数 `LINE_USER_ID` に設定します。

## 5. Groq API健康アドバイス機能の設定

健康アドバイスの生成にGroq APIを使用する場合、以下の手順で設定します：

### 5.1 Groq APIの設定
1. [Groq](https://console.groq.com/)でアカウントを作成し、APIキーを取得
2. 以下の環境変数を設定：
   - `GROQ_API_KEY`: GroqのAPIキー
   - `USE_GROQ`: `true`に設定

Groq APIで使用されるモデルは`llama-3.3-70b-versatile`です。このモデルは、より自然な会話調で個人的なアドバイスを生成できる最新のモデルです。

**注意**: Groq APIが有効でない場合や、APIの呼び出しに失敗した場合は、デフォルトの健康アドバイスが使用されます。

## 6. 動作確認

1. Lambda関数のテスト機能を使用して、関数を手動で実行します。
2. 正常に実行されると、設定したLINEアカウントに以下の情報が送信されます：
   - 現在の気圧情報
   - 24時間の気圧変化
   - 24時間気圧予報
   - 気圧変化に基づく健康アドバイス
3. EventBridgeのルールが設定した時間に実行されることを確認します。
4. CloudWatchログを確認して、エラーがないことを確認します。

## 7. トラブルシューティング

### 7.1 LINE通知の問題

1. **アクセストークンの有効期限切れ**:
   - エラーメッセージ: `Authentication failed. Confirm that the access token in the authorization header is valid.`
   - 解決方法: LINE Developersコンソールで新しいアクセストークンを発行し、Lambda環境変数を更新

2. **ユーザーIDの問題**:
   - LINE Botが友達に追加されていることを確認
   - ユーザーIDが正しく環境変数に設定されていることを確認

### 7.2 気圧データの取得エラー

1. **OpenWeatherMap APIの問題**:
   - APIキーの有効性を確認
   - City IDが正しいことを確認（松江市: 1857550）
   - API呼び出し制限に達していないか確認

### 7.3 Groq APIの問題

1. **APIキーの問題**:
   - APIキーの有効性を確認
   - 環境変数`GROQ_API_KEY`が正しく設定されているか確認

2. **レスポンスタイムアウト**:
   - Lambda関数のタイムアウト設定（30秒）が適切か確認
   - Groq APIの応答が遅い場合は、デフォルトのアドバイスが使用されます

### 7.4 S3の問題

1. **アクセス権限エラー**:
   - IAMロールのポリシーが正しく設定されているか確認
   - バケット名が正しいか確認

2. **データ保存エラー**:
   - CloudWatchログでエラーメッセージを確認
   - S3バケットの容量制限に達していないか確認

## 8. 定期メンテナンス

以下の項目を定期的に確認することをお勧めします：

1. LINE Botのアクセストークンの有効期限
2. CloudWatchログのエラーチェック
3. S3バケットの使用状況
4. API呼び出し制限の使用状況

## 9. セキュリティ上の注意

1. APIキーやアクセストークンは必ずLambda環境変数として設定し、コード内にハードコードしない
2. S3バケットは必要最小限のアクセス権限のみを付与
3. LINE Botのアクセストークンは定期的に更新
4. CloudWatchログに機密情報が出力されていないか確認
